name: Deploy Infrastructure

on:
  push:
    branches:
      - main
      - develop
    paths:
      - "infrastructure/**"
  pull_request:
    branches:
      - main
    paths:
      - "infrastructure/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - staging
          - prod
      destroy:
        description: "Destroy infrastructure"
        required: false
        default: false
        type: boolean

env:
  TF_VERSION: "1.6.0"
  AWS_REGION: "us-east-1"
  TERRAFORM_DIR: "./infrastructure/terraform"

jobs:
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

      - name: Run Checkov static analysis
        uses: bridgecrewio/checkov-action@master
        with:
          directory: .
          framework: terraform
          output_format: sarif
          output_file_path: checkov-results.sarif

      - name: Upload Checkov scan results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: checkov-results.sarif

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: always() && (needs.security-scan.result == 'success' || github.event_name != 'pull_request')

    strategy:
      matrix:
        environment: [dev, staging, prod]

    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ matrix.environment }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ secrets.TF_STATE_LOCK_TABLE }}"
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Validate
        run: terraform validate
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Plan
        run: |
          terraform plan \
            -var-file="environments/${{ matrix.environment }}.tfvars" \
            -out="${{ matrix.environment }}.tfplan" \
            -detailed-exitcode
        working-directory: ${{ env.TERRAFORM_DIR }}
        continue-on-error: true
        id: plan

      - name: Upload Terraform Plan
        uses: actions/upload-artifact@v3
        with:
          name: terraform-plan-${{ matrix.environment }}
          path: ${{ env.TERRAFORM_DIR }}/${{ matrix.environment }}.tfplan
          retention-days: 30

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('${{ env.TERRAFORM_DIR }}/${{ matrix.environment }}.tfplan.txt', 'utf8');
            const output = `#### Terraform Plan for ${{ matrix.environment }} ðŸ“–

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            ${plan}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    strategy:
      matrix:
        environment: [dev, staging, prod]

    environment: ${{ matrix.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Download Terraform Plan
        uses: actions/download-artifact@v3
        with:
          name: terraform-plan-${{ matrix.environment }}
          path: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=${{ matrix.environment }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}" \
            -backend-config="encrypt=true" \
            -backend-config="dynamodb_table=${{ secrets.TF_STATE_LOCK_TABLE }}"
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Apply
        if: ${{ !github.event.inputs.destroy }}
        run: terraform apply -auto-approve "${{ matrix.environment }}.tfplan"
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Destroy
        if: ${{ github.event.inputs.destroy == 'true' }}
        run: |
          terraform destroy \
            -var-file="environments/${{ matrix.environment }}.tfvars" \
            -auto-approve
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Update Infrastructure Documentation
        if: ${{ !github.event.inputs.destroy }}
        run: |
          terraform output -json > infrastructure-outputs-${{ matrix.environment }}.json
          terraform show -json > infrastructure-state-${{ matrix.environment }}.json
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Upload Infrastructure State
        if: ${{ !github.event.inputs.destroy }}
        uses: actions/upload-artifact@v3
        with:
          name: infrastructure-state-${{ matrix.environment }}
          path: |
            ${{ env.TERRAFORM_DIR }}/infrastructure-outputs-${{ matrix.environment }}.json
            ${{ env.TERRAFORM_DIR }}/infrastructure-state-${{ matrix.environment }}.json
          retention-days: 90

  compliance-check:
    name: Compliance Check
    runs-on: ubuntu-latest
    needs: [terraform-apply]
    if: always() && needs.terraform-apply.result == 'success'

    strategy:
      matrix:
        environment: [dev, staging, prod]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: GitHubActions-${{ github.run_id }}

      - name: Run AWS Config Compliance Check
        run: |
          aws configservice get-compliance-summary-by-config-rule \
            --region ${{ env.AWS_REGION }} \
            --output table

      - name: Run AWS Security Hub Findings
        run: |
          aws securityhub get-findings \
            --region ${{ env.AWS_REGION }} \
            --filters '{"ComplianceStatus":[{"Value":"FAILED","Comparison":"EQUALS"}]}' \
            --max-items 50 \
            --output table

      - name: Generate Compliance Report
        run: |
          echo "# Infrastructure Compliance Report - ${{ matrix.environment }}" > compliance-report-${{ matrix.environment }}.md
          echo "Generated on: $(date)" >> compliance-report-${{ matrix.environment }}.md
          echo "" >> compliance-report-${{ matrix.environment }}.md
          echo "## AWS Config Compliance" >> compliance-report-${{ matrix.environment }}.md
          aws configservice get-compliance-summary-by-config-rule --region ${{ env.AWS_REGION }} >> compliance-report-${{ matrix.environment }}.md
          echo "" >> compliance-report-${{ matrix.environment }}.md
          echo "## Security Hub Findings" >> compliance-report-${{ matrix.environment }}.md
          aws securityhub get-findings --region ${{ env.AWS_REGION }} --filters '{"ComplianceStatus":[{"Value":"FAILED","Comparison":"EQUALS"}]}' --max-items 10 >> compliance-report-${{ matrix.environment }}.md

      - name: Upload Compliance Report
        uses: actions/upload-artifact@v3
        with:
          name: compliance-report-${{ matrix.environment }}
          path: compliance-report-${{ matrix.environment }}.md
          retention-days: 365

  notification:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [terraform-apply, compliance-check]
    if: always()

    steps:
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL }}
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: "#infrastructure"
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

      - name: Send email notification
        if: ${{ secrets.SMTP_SERVER }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: Infrastructure Deployment - ${{ job.status }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <noreply@github.com>
          body: |
            Infrastructure deployment completed with status: ${{ job.status }}

            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            Workflow: ${{ github.workflow }}

            View details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
